# my-auto-deploy
ğŸ‰Power Design By æ‰“é…±æ²¹ğŸ‰
## é¡¹ç›®ç®€ä»‹

> è¯¥é¡¹ç›®æ˜¯åŸºäº`node`å®ç°ï¼Œæ”¯æŒå‰ç«¯é¡¹ç›®è¿›è¡Œlegacyã€dockerã€docker-composeå¤šç§æ–¹å¼çš„è¿œç«¯è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚

è¯¥é¡¹ç›®æŒç»­æ›´æ–°ä¸­ï¼Œæ¬¢è¿æäº¤ `pr`åŠ`issues` ğŸ˜˜

**æ›´æ–°ï¼š**
- ğŸ‰ç°å·²æ”¯æŒlegacyã€dockerã€docker-composeä¸‰ç§éƒ¨ç½²æ–¹å¼
- ğŸ‰ç°å·²æ”¯æŒ **ä¸Šä¼ ç¼–è¯‘åä»£ç éƒ¨ç½²**ã€**ä¸Šä¼ å‰ç«¯æºç è¿œç«¯ç¼–è¯‘éƒ¨ç½²**ä¸¤ç§æ–¹å¼
ï¼ˆpsï¼šè¿œç«¯ç¼–è¯‘ä»…æ”¯æŒdockeræ¨¡å¼ï¼‰
- ç°å·²æ”¯æŒå¤šé…ç½®ä¿¡æ¯ï¼Œæ”¯æŒéƒ¨ç½²æ—¶é€‰æ‹©é¡¹ç›®ã€éƒ¨ç½²æ–¹å¼ã€ä¸Šä¼ ç¼–è¯‘æ–¹å¼
- ç°å·²æ”¯ä¿®æ”¹æœåŠ¡å™¨è¿æ¥ç«¯å£ï¼Œæ”¯æŒsshç§é’¥åŠè§£å¯†å¯†ç è¿æ¥
- ç°å·²æ”¯æŒè¿œç«¯å¤‡ä»½ï¼Œæ—¶é—´æ ¼å¼åç¼€ `yyyy-MM-dd_HH:mm:ss`

## æ”¯æŒ
|éƒ¨ç½²æ–¹å¼|legacy|docker|docker-compose|
|-------|:----:|:----:|:------------:|
|æœ¬åœ°æ‰“åŒ…ç¼–è¯‘distğŸ”¶| âœ”|   âœ” |    âœ”  |
|æºç è¿œç«¯æ‰“åŒ…ç¼–è¯‘ğŸ”·|âŒ|   âœ” |    âœ”  |

## è¯´æ˜
é…ç½®æ–‡ä»¶(`src/config/config.js`)

ğŸ”¶ä¸Šä¼ æœ¬åœ°ç¼–è¯‘åæ–‡ä»¶å¤¹ (dist)

ğŸ”·ä¸Šä¼ æºç è¿œç«¯æ‰“åŒ…ç¼–è¯‘ (source)

éƒ¨ç½²æ–¹å¼è¯´æ˜ï¼š
- legacyï¼ˆç‰©ç†éƒ¨ç½²ï¼‰
  - è¯·å°†æ–‡ä»¶ä¸Šä¼ è‡³`nginx`é…ç½®å¯¹åº”ç›®å½•
- docker
  - ç«¯å£ä¿®æ”¹è¯·å‚ç…§`é…ç½®æ–‡ä»¶` --> ports
  - ğŸ”¶ä¸Šä¼ distè¯·å‚ç…§`é…ç½®æ–‡ä»¶` --> docker_file
  - ğŸ”·ä¸Šä¼ sourceè¯·å‚ç…§`é…ç½®æ–‡ä»¶` --> docker_file__build
  - ğŸ”·sourceä¸­æ— éœ€ä¸Šä¼ æ–‡ä»¶è¿‡æ»¤è¯·å‚ç…§`é…ç½®æ–‡ä»¶` --> exclude
  - å…¶ä»–éœ€æ±‚å¯è‡ªè¡Œä¿®æ”¹å¯¹åº”`Dockerfile`
- docker-compose
  - `docker-compose.yml`ä¸­å®¹å™¨åã€é•œåƒåè¯·ä¿æŒä¸`é…ç½®æ–‡ä»¶`ä¸€è‡´
  - ç«¯å£ä¿®æ”¹è¯·å‚ç…§`docker-compose.yml` --> ports
  - å…¶ä»–éœ€æ±‚å¯è‡ªè¡Œä¿®æ”¹å¯¹åº”`docker-compose.yml`

## ä½¿ç”¨
Tipï¼šè¯·ç¡®ä¿å·²å®‰è£…nodeã€npm
```bash
npm install # å®‰è£…ä¾èµ–
npm run deploy # æœ¬åœ°è¿è¡Œ
```

ä½¿ç”¨æµç¨‹ï¼š
> é€‰æ‹©é¡¹ç›®-->é€‰æ‹©éƒ¨ç½²æ–¹å¼-->é€‰æ‹©ä¸Šä¼ æºç orç¼–è¯‘åä»£ç -->è¿œç«¯è‡ªåŠ¨éƒ¨ç½²

## ä¼˜ç‚¹
- è½»é‡ã€ä¾¿æ·ã€é«˜æ•ˆ
- æ”¯æŒlegacyã€dockerã€docker-composeå¤šç§æ–¹å¼è‡ªåŠ¨éƒ¨ç½²
- æ”¯æŒ å¤šé¡¹ç›®ç®¡ç†ã€å¤šæ–¹å¼è¿æ¥ã€æœ¬åœ°å‹ç¼©ã€è¿œç«¯å¤‡ä»½ç­‰

## é…ç½®æ–‡ä»¶è¯´æ˜
```js
/*
config.js
ğŸ”¶ä¸Šä¼ æœ¬åœ°ç¼–è¯‘åæ–‡ä»¶å¤¹ (dist)
ğŸ”·ä¸Šä¼ æºç è¿œç«¯æ‰“åŒ…ç¼–è¯‘ (source)
è¯´æ˜ï¼š
  name: é¡¹ç›®åç§°
  ssh: è¿æ¥æœåŠ¡å™¨ä¿¡æ¯
  openBackUp: æ˜¯å¦å¼€å¯è¿œç«¯å¤‡ä»½
  deployDir: è¿œç«¯éƒ¨ç½²ç›®å½•
  releaseDir: å‘å¸ƒç›®å½•
  distDir: webç¼–è¯‘åç›®å½•ğŸ”¶
  docker_file: Dockerfileæ–‡ä»¶ä½ç½®ğŸ”¶
  sourceDir: webæºç ç›®å½•(äº‘ç«¯ä»£ç ç¼–è¯‘ä½¿ç”¨ï¼Œä»…æ”¯æŒdockeræ¨¡å¼)ğŸ”·
  exclude: æºç ç›®å½•ä¸­æ’é™¤ä¸Šä¼ æ–‡ä»¶ ğŸ”·
  docker_file__build: æ”¯æŒæºç ç¼–è¯‘Dockerfileæ–‡ä»¶ä½ç½®ğŸ”·
  image: ç¼–è¯‘åé•œåƒå
  ports: ç«¯å£æ˜ å°„ï¼ˆå®¿ä¸»æœº:å†…éƒ¨ï¼Œè¯·ç¡®ä¿å®¿ä¸»æœºç«¯å£å·²å¼€æ”¾ï¼‰
  container_name: å®¹å™¨åç§°
  docker_compose: docker-composeæ–‡ä»¶ä½ç½®
  ç«¯å£ä¿®æ”¹è¯·å‚ç…§`docker-compose.yml` --> ports
  `docker-compose.yml`ä¸­å®¹å™¨åã€é•œåƒåè¯·ä¿æŒä¸`é…ç½®æ–‡ä»¶`ä¸€è‡´
æ›´æ–°ï¼š
  - ğŸ‰ç°å·²æ”¯æŒlegacyã€dockerã€docker-composeä¸‰ç§éƒ¨ç½²æ–¹å¼
  - ğŸ‰ç°å·²æ”¯æŒ **ä¸Šä¼ ç¼–è¯‘åä»£ç éƒ¨ç½²**ã€**ä¸Šä¼ å‰ç«¯æºç è¿œç«¯ç¼–è¯‘éƒ¨ç½²**ä¸¤ç§æ–¹å¼
  ï¼ˆpsï¼šè¿œç«¯ç¼–è¯‘ä»…æ”¯æŒdockeræ¨¡å¼ï¼‰
  - ç°å·²æ”¯æŒå¤šé…ç½®ä¿¡æ¯ï¼Œæ”¯æŒéƒ¨ç½²æ—¶é€‰æ‹©é¡¹ç›®ã€éƒ¨ç½²æ–¹å¼ã€ä¸Šä¼ ç¼–è¯‘æ–¹å¼
  - ç°å·²æ”¯ä¿®æ”¹æœåŠ¡å™¨è¿æ¥ç«¯å£ï¼Œæ”¯æŒsshç§é’¥åŠè§£å¯†å¯†ç è¿æ¥
  - ç°å·²æ”¯æŒè¿œç«¯å¤‡ä»½ï¼Œæ—¶é—´æ ¼å¼åç¼€ `yyyy-MM-dd_HH:mm:ss`
  */

const config = [
  {
    name: 'ç¤ºä¾‹é¡¹ç›®',
    ssh: {
      host: '120.26.51.81',
      port: 22,
      username: 'root',
      password: 'xx',
      // privateKey: 'E:/id_rsa', // sshç§é’¥(ä¸ä½¿ç”¨æ³¨é‡Šå³å¯)
      // passphrase: '123456' // sshç§é’¥å¯¹åº”è§£å¯†å¯†ç (ä¸å­˜åœ¨è®¾ä¸º''å³å¯)
    },
    openBackUp: true, // æ˜¯å¦å¼€å¯è¿œç«¯å¤‡ä»½
    deployDir: '/app' + '/', // è¿œç«¯éƒ¨ç½²ç›®å½•
    releaseDir: 'spa-web', // å‘å¸ƒç›®å½•ï¼ˆæœ€ç»ˆå‘å¸ƒç›®å½•ä¸º/app/spa-appï¼‰
    distDir: 'E:/XX/dist', // webç¼–è¯‘åç›®å½•ğŸ”¶
    // ä»¥ä¸‹ä¸ºdockeræ¨¡å¼ä¸‹ä½¿ç”¨é…ç½®
    docker_file: './Dockerfile_nginx/Dockerfile', // Dockerfileæ–‡ä»¶ä½ç½®ğŸ”¶
    sourceDir: 'E:/XX', // webæºç ç›®å½•ğŸ”·
    exclude: [ //  æºç ç›®å½•ä¸­ é»˜è®¤æ’é™¤ä¸Šä¼  node_modules, dist, .gitğŸ”·
      'node_modules',
      'dist',
      '.git',
    ],
    docker_file__build: './Dockerfile_node_nginx/Dockerfile', // æ”¯æŒæºç ç¼–è¯‘Dockerfileæ–‡ä»¶ä½ç½®ğŸ”·
    image: 'spa/web:dev', // ç¼–è¯‘åé•œåƒå
    ports: '8800:80', // ç«¯å£æ˜ å°„ï¼ˆå®¿ä¸»æœº:å†…éƒ¨ï¼Œè¯·ç¡®ä¿å®¿ä¸»æœºç«¯å£å·²å¼€æ”¾ï¼‰
    container_name: 'spa_web', // å®¹å™¨åç§°
    docker_compose: './docker-compose.yml' // docker-composeæ–‡ä»¶ä½ç½®
    // ç«¯å£ä¿®æ”¹è¯·å‚ç…§`docker-compose.yml` --> ports
    // `docker-compose.yml`ä¸­å®¹å™¨åã€é•œåƒåè¯·ä¿æŒä¸`é…ç½®æ–‡ä»¶`ä¸€è‡´
  }
]
```
## æ³¨æ„äº‹é¡¹

- ä½¿ç”¨dockeréƒ¨ç½²æ–¹å¼ï¼Œè¯·æå‰å®‰è£…dockerã€docker-compose(æ–°ç‰ˆæœ¬æœ€ä½³)
- è‹¥æœåŠ¡å™¨ç½‘é€Ÿè¾ƒæ…¢ï¼Œå¯æå‰å®‰è£…`node`å’Œ`nginx`çš„dockeré•œåƒï¼Œä»¥ä¾¿åŠ å¿«åç»­éƒ¨ç½²é€Ÿåº¦
  - docker pull node:lts-alpine3.12
  - docker pull socialengine/nginx-spa:latest
- è‹¥å› docker-composeç‰ˆæœ¬è¿‡ä½ï¼Œå¯¼è‡´éƒ¨ç½²å¤±è´¥
  - å¯é™ä½`docker-compose.yml` version: "2.x"ï¼ˆé™ä¸º2.0+ çš„ç‰ˆæœ¬ï¼‰
  - æˆ–å‡çº§è‡³æœ€æ–°ç‰ˆæœ¬`docker-compose`
- è¿œç«¯æºç ç¼–è¯‘ä¸­ä¼šäº§ç”Ÿ`<none>`ä¸´æ—¶é•œåƒï¼Œç”¨äºåŠ å¿«ä¸‹æ¬¡æ„å»ºé€Ÿåº¦ï¼Œæ— éœ€åˆ é™¤
- è¯·ç¡®è®¤å®¿ä¸»æœºç«¯å£å·²å¼€æ”¾

## ç¤ºä¾‹
è¿™é‡Œé€‰å–ä¸¤ç§æƒ…å†µè¿›è¡Œå±•ç¤ºï¼š
- docker + source build
- docker-compose + dist

è¿™é‡Œä»¥`react`çš„[åœ¨çº¿å£çº¸](https://github.com/aotianwinter/my-picture-online)ä¸ºä¾‹ï¼ŒæœåŠ¡å™¨å·²å¼€æ”¾8800ã€8900ç«¯å£ã€‚

1. æ‹‰å–ä»£ç è‡³æœ¬åœ°ï¼Œå®‰è£…ä¾èµ–ï¼Œæ‰§è¡Œæœ¬åœ°æ„å»ºï¼Œç›®å½•å¦‚å›¾ï¼š

![](https://user-gold-cdn.xitu.io/2020/7/30/1739d72f81668195?w=688&h=278&f=png&s=25319)

1. è¯¥é¡¹ç›®æ„å»ºåäº§ç”Ÿ`build`æ–‡ä»¶å¤¹ä¸”ä¸å­˜åœ¨`package-lock.json`æ–‡ä»¶ï¼Œå› æ­¤ä¿®æ”¹`é…ç½®æ–‡ä»¶`å’Œ`Dockerfile`ï¼Œå¦‚å›¾

**é…ç½®æ–‡ä»¶**

![](https://user-gold-cdn.xitu.io/2020/7/30/1739d74315c5edfe?w=1077&h=873&f=png&s=157541)

**Dockerfile**

![](https://user-gold-cdn.xitu.io/2020/7/30/1739d8235d1bd492?w=698&h=467&f=png&s=48024)

3. è¿è¡Œéƒ¨ç½²ç¨‹åºï¼Œé€‰æ‹©ç›¸åº”ä¿¡æ¯å¼€å§‹éƒ¨ç½²ï¼Œç›´è‡³éƒ¨ç½²å®Œæˆï¼Œå¦‚å›¾

**é€‰æ‹©éƒ¨ç½²**

![](https://user-gold-cdn.xitu.io/2020/7/30/1739d824e0a217a8?w=557&h=225&f=png&s=16860)
   
**éƒ¨ç½²æˆåŠŸ**ï¼ˆå®¹å™¨ä¿¡æ¯å’Œé¢„æœŸç»“æœä¸€è‡´ï¼‰

![](https://user-gold-cdn.xitu.io/2020/7/30/1739d8267e3c99eb?w=1211&h=769&f=png&s=73304)

4. è®¿é—®å¯¹åº”åœ°å€ï¼ŒéªŒè¯éƒ¨ç½²æˆåŠŸï¼Œå¦‚å›¾

![](https://user-gold-cdn.xitu.io/2020/7/30/1739d8fa400dedd7?w=1693&h=818&f=png&s=1414082)

5. ä¿®æ”¹ `docker-compose.yml` ç«¯å£ä¸º8900åï¼Œå†æ¬¡è¿›è¡Œéƒ¨ç½²ï¼Œå¦‚å›¾

**docker-compose.yml**

![](https://user-gold-cdn.xitu.io/2020/7/30/1739d93f3446d13e?w=662&h=267&f=png&s=22693)

**é€‰æ‹©éƒ¨ç½²**

![](https://user-gold-cdn.xitu.io/2020/7/30/1739d8fcd3bd20f8?w=686&h=224&f=png&s=17609)

6. ç”±äºå­˜åœ¨åŒåå®¹å™¨ï¼Œéƒ¨ç½²è¿‡ç¨‹ä¸­ä¼šåœæ­¢å¹¶åˆ é™¤åŒåå®¹å™¨ï¼Œä¹‹åä½¿ç”¨æœ€æ–°çš„é•œåƒå¯åŠ¨å®¹å™¨ï¼Œå¦‚å›¾

![](https://user-gold-cdn.xitu.io/2020/7/30/1739d8fd52912f99?w=1202&h=493&f=png&s=49397)

7. è®¿é—®å¯¹åº”åœ°å€ï¼ŒéªŒè¯éƒ¨ç½²æˆåŠŸï¼Œå¦‚å›¾

![](https://user-gold-cdn.xitu.io/2020/7/30/1739d97bbe85a3e1?w=1693&h=818&f=png&s=1253755)
