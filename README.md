# my-auto-deploy
ğŸ‰Power Design By æ‰“é…±æ²¹ğŸ‰
## é¡¹ç›®ç®€ä»‹

> è¯¥é¡¹ç›®æ˜¯åŸºäº`node`å®ç°ï¼Œæ”¯æŒå‰ç«¯é¡¹ç›®è¿›è¡Œlegacyã€dockerã€docker-composeå¤šç§æ–¹å¼çš„è¿œç«¯è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚

è¯¥é¡¹ç›®æŒç»­æ›´æ–°ä¸­ï¼Œæ¬¢è¿æäº¤ `pr`åŠ`issues` ğŸ˜˜

**æ›´æ–°ï¼š**
- ğŸ‰ç°å·²æ”¯æŒlegacyã€dockerã€docker-composeä¸‰ç§éƒ¨ç½²æ–¹å¼
- ç°å·²æ”¯æŒæ·»åŠ å¤šä¸ªé…ç½®ä¿¡æ¯ï¼Œè‡ªåŠ¨åŒ–éƒ¨ç½²æ—¶æ”¯æŒé€‰æ‹©é…ç½®ä¿¡æ¯è¿è¡Œ
- ç°å·²æ”¯ä¿®æ”¹æœåŠ¡å™¨è¿æ¥ç«¯å£ï¼Œæ”¯æŒsshç§é’¥åŠè§£å¯†å¯†ç è¿æ¥ï¼ˆpsï¼šä¸ä½¿ç”¨æ­¤æ–¹æ³•æ—¶ï¼Œè¯·æ³¨é‡ŠprivateKeyï¼‰
- ç°å·²æ”¯æŒè¿œç«¯å¤‡ä»½ï¼Œæ—¶é—´æ ¼å¼æ”¹ä¸º `yyyy-MM-dd_HH:mm:ss`

## è¯´æ˜
éƒ¨ç½²æ–¹å¼è¯´æ˜ï¼š
- legacyï¼ˆç‰©ç†éƒ¨ç½²ï¼‰ï¼Œè¯·å°†æ–‡ä»¶ä¸Šä¼ è‡³nginxé…ç½®ç›®å½•ã€‚
- dockerï¼Œç«¯å£ä¿®æ”¹è¯·å‚ç…§å¯¹åº”é¡¹ç›®çš„Dockerfileçš„å†…å¤–æ˜ å°„ç«¯å£é…ç½®ã€‚
- docker-composeï¼Œç«¯å£ä¿®æ”¹è¯·å‚ç…§å¯¹åº”é¡¹ç›®çš„Dockerfileçš„å†…å¤–æ˜ å°„ç«¯å£é…ç½®ï¼Œè¿è¡Œå…³è”å®¹å™¨è¯·ä¿®æ”¹`docker-compose.yml`æ–‡ä»¶ã€‚

ä¼˜ç‚¹ï¼š
  - è½»é‡ã€ä¾¿æ·ã€é«˜æ•ˆ
  - æ”¯æŒlegacyã€dockerã€docker-composeå¤šç§æ–¹å¼è‡ªåŠ¨éƒ¨ç½²
  - æ”¯æŒ å¤šé¡¹ç›®ç®¡ç†ã€å¤šæ–¹å¼è¿æ¥ã€æœ¬åœ°å‹ç¼©ã€è¿œç«¯å¤‡ä»½ç­‰

## æ”¯æŒ
|éƒ¨ç½²æ–¹å¼|legacy|docker|docker-compose|
|-------|:----:|:----:|:------------:|
|æºç è¿œç«¯æ‰“åŒ…ç¼–è¯‘|âŒ|   âœ” |     âœ”    |
|æœ¬åœ°æ‰“åŒ…ç¼–è¯‘dist| âœ”|   âœ” |     âœ”    |

## ä½¿ç”¨

> Tipï¼šè¯·ç¡®ä¿å·²å®‰è£…nodeã€npm
```bash
npm install # å®‰è£…ä¾èµ–
npm run deploy # æœ¬åœ°è¿è¡Œ
```

## ç¤ºä¾‹

## é…ç½®æ–‡ä»¶è¯´æ˜
```js
/*
config.js
è¯´æ˜ï¼š
  è¯·ç¡®ä¿è§£å‹åçš„æ–‡ä»¶ç›®å½•ä¸ºdist
  ssh: è¿æ¥æœåŠ¡å™¨ç”¨æˆ·ä¿¡æ¯
  targetDir: éœ€è¦å‹ç¼©çš„æ–‡ä»¶ç›®å½•ï¼ˆå¯ç”¨æœ¬åœ°å‹ç¼©åç”Ÿæ•ˆï¼‰
  targetFile: æŒ‡å®šä¸Šä¼ æ–‡ä»¶åç§°ï¼ˆconfig.jsåŒçº§ç›®å½•ï¼‰
  openCompress: å…³é—­åï¼Œå°†è·³è¿‡æœ¬åœ°æ–‡ä»¶å‹ç¼©ï¼Œç›´æ¥ä¸Šä¼ åŒçº§ç›®å½•ä¸‹æŒ‡å®šæ–‡ä»¶
  openBackUp: å¼€å¯åï¼Œè‹¥è¿œç«¯å­˜åœ¨ç›¸åŒç›®å½•ï¼Œåˆ™ä¼šä¿®æ”¹åŸå§‹ç›®å½•åç§°ï¼Œä¸ä¼šç›´æ¥è¦†ç›–
  deployDir: æŒ‡å®šè¿œç«¯éƒ¨ç½²åœ°å€
  releaseDir: æŒ‡å®šè¿œç«¯éƒ¨ç½²åœ°å€ä¸‹çš„å‘å¸ƒç›®å½•åç§°
æ›´æ–°ï¼š
  ğŸ‰ç°å·²æ”¯æŒæ·»åŠ å¤šä¸ªé…ç½®ä¿¡æ¯ï¼Œè‡ªåŠ¨åŒ–éƒ¨ç½²æ—¶æ”¯æŒé€‰æ‹©é…ç½®ä¿¡æ¯è¿è¡Œ
  ğŸ‰ç°å·²æ”¯ä¿®æ”¹æœåŠ¡å™¨è¿æ¥ç«¯å£ï¼Œæ”¯æŒsshç§é’¥åŠè§£å¯†å¯†ç è¿æ¥ï¼ˆpsï¼šä¸ä½¿ç”¨æ­¤æ–¹æ³•æ—¶ï¼Œè¯·æ³¨é‡ŠprivateKeyï¼‰
  ğŸ‰ç°å·²æ›´æ–°æ¨¡å—å¼•ç”¨é€»è¾‘ï¼Œè¿œç«¯å¤‡ä»½æ—¶é—´æ ¼å¼æ”¹ä¸º `yyyy-MM-dd_HH:mm:ss`
*/

const config = [
  {
    name: 'é¡¹ç›®A-dev',
    ssh: {
      host: '192.168.0.110',
      port: 22,
      username: 'root',
      password: 'root',
      privateKey: 'E:/id_rsa', // sshç§é’¥(ä¸ä½¿ç”¨æ­¤æ–¹æ³•æ—¶è¯·å‹¿å¡«å†™ï¼Œ æ³¨é‡Šå³å¯)
      passphrase: '123456' // sshç§é’¥å¯¹åº”è§£å¯†å¯†ç (ä¸å­˜åœ¨è®¾ä¸º''å³å¯)
    },
    targetDir: 'E:/private/my-vue-cli/dist', // ç›®æ ‡å‹ç¼©ç›®å½•(å¯ä½¿ç”¨ç›¸å¯¹åœ°å€)
    targetFile: 'dist.zip', // ç›®æ ‡æ–‡ä»¶
    openBackUp: true, // æ˜¯å¦å¼€å¯è¿œç«¯å¤‡ä»½
    deployDir: '/home/node_test' + '/', // è¿œç«¯ç›®å½•
    releaseDir: 'web' // å‘å¸ƒç›®å½•
  },
  {
    name: 'é¡¹ç›®A-prod',
    ssh: {
      host: '192.168.0.110',
      port: 22,
      username: 'root',
      password: 'root',
      privateKey: 'E:/id_rsa', // sshç§é’¥(ä¸ä½¿ç”¨æ­¤æ–¹æ³•æ—¶è¯·å‹¿å¡«å†™ï¼Œ æ³¨é‡Šå³å¯)
      passphrase: '123456' // sshç§é’¥å¯¹åº”è§£å¯†å¯†ç (ä¸å­˜åœ¨è®¾ä¸º''å³å¯)
    },
    targetDir: 'E:/private/my-vue-cli/dist', // ç›®æ ‡å‹ç¼©ç›®å½•(å¯ä½¿ç”¨ç›¸å¯¹åœ°å€)
    targetFile: 'dist.zip', // ç›®æ ‡æ–‡ä»¶
    openBackUp: true, // æ˜¯å¦å¼€å¯è¿œç«¯å¤‡ä»½
    deployDir: '/home/node_test' + '/', // è¿œç«¯ç›®å½•
    releaseDir: 'web2' // å‘å¸ƒç›®å½•
  }
]
```
